### 调整测试方案使make test全平台通过 ###
调整 build tag 策略和 Makefile，使 make test 在所有平台（包括 Linux）都使用 fakeipvs 实现通过测试，make test-linux 使用真实 IPVS handle 仅在 Linux 上运行。


## 核心思路

当前 fakeHandle 使用 `//go:build !linux` 限制，导致 Linux 上无法使用 fake 实现。需要将"是否使用真实 IPVS"的判断从**平台 build tag**改为**自定义 build tag**（如 `integration`），这样：

- `make test`：不带任何 tag，所有平台（含 Linux）都编译 fakeHandle，使用内存模拟
- `make test-linux`：带 `-tags integration` tag，Linux 上编译真实 IPVS handle

---

## 步骤 1：修改 `pkg/lvs/ipvs_handle_fake.go` 的 build tag

- **当前**：`//go:build !linux`
- **改为**：`//go:build !integration`

这样在不传 tag 时（`make test`），所有平台都会编译 fakeHandle。

## 步骤 2：修改 `pkg/lvs/ipvs_handle_linux.go` 的 build tag

- **当前**：`//go:build linux`
- **改为**：`//go:build integration`

这样只有显式传 `-tags integration` 时才编译真实 IPVS handle。由于 `moby/ipvs` 依赖 Linux netlink，此文件本身只能在 Linux 上编译成功，`integration` tag 天然只会在 Linux 上使用。

## 步骤 3：修改 `pkg/lvs/ipvs_handle_fake_test.go` 的 build tag

- **当前**：`//go:build !linux`
- **改为**：`//go:build !integration`

fakeHandle 的单元测试在所有平台的 `make test` 中都运行。

## 步骤 4：调整 `pkg/lvs/` 下的 test helper 文件

### 4.1 `pkg/lvs/test_helper_other_test.go`
- **当前**：`//go:build !linux`
- **改为**：`//go:build !integration`
- 内容不变（使用 fakeHandle 创建 Manager，无需 Flush）

### 4.2 `pkg/lvs/test_helper_linux_test.go`
- **当前**：`//go:build linux`
- **改为**：`//go:build integration`
- 内容不变（使用真实 IPVS handle，含 Flush 清理逻辑）

### 4.3 `pkg/lvs/testmain_linux_test.go`
- **当前**：`//go:build linux`
- **改为**：`//go:build integration`
- 内容不变（TestMain 做 IPVS Flush 初始化/清理）

## 步骤 5：调整 `pkg/server/` 下的 test helper 文件

### 5.1 `pkg/server/test_helper_other_test.go`
- **当前**：`//go:build !linux`
- **改为**：`//go:build !integration`

### 5.2 `pkg/server/test_helper_linux_test.go`
- **当前**：`//go:build linux`
- **改为**：`//go:build integration`

### 5.3 `pkg/server/testmain_linux_test.go`
- **当前**：`//go:build linux`
- **改为**：`//go:build integration`

## 步骤 6：确认无需修改的文件

以下文件**无 build tag**，不需要修改：
- `pkg/lvs/reconciler_test.go` — 通过 `newTestManager()` 间接选择实现，无需改动
- `pkg/server/server_integration_test.go` — 通过 `newTestServer()` 间接选择实现，无需改动
- `pkg/config/config_test.go` — 纯配置解析测试，不涉及 IPVS

以下文件保持不变：
- `tests/e2e/` 下所有文件 — 保持 `//go:build linux`，e2e 测试始终需要真实 Linux 环境

## 步骤 7：修改 Makefile

```makefile
.PHONY: test
test: ## run unit tests (all platforms, using fake IPVS)
	@echo "Running unit tests..."
	@go test -v ./...
	@echo "Tests completed"

# test-linux runs tests with real IPVS handle, serially (-p 1) because IPVS is a global kernel resource.
# Must be run as root on Linux.
.PHONY: test-linux
test-linux: ## run unit tests with real IPVS (Linux only)
	@echo "Running unit tests for linux..."
	@go test -count=1 -p 1 -tags integration ./...
	@echo "Tests completed"
```

关键变化：`test-linux` 增加 `-tags integration`，使其编译真实 IPVS handle。

## 步骤 8：验证

在 macOS 上运行 `make test`，确认所有测试通过（使用 fakeHandle）。

---

## 变更文件汇总

| 文件 | 变更 |
|------|------|
| `pkg/lvs/ipvs_handle_fake.go` | `!linux` -> `!integration` |
| `pkg/lvs/ipvs_handle_linux.go` | `linux` -> `integration` |
| `pkg/lvs/ipvs_handle_fake_test.go` | `!linux` -> `!integration` |
| `pkg/lvs/test_helper_other_test.go` | `!linux` -> `!integration` |
| `pkg/lvs/test_helper_linux_test.go` | `linux` -> `integration` |
| `pkg/lvs/testmain_linux_test.go` | `linux` -> `integration` |
| `pkg/server/test_helper_other_test.go` | `!linux` -> `!integration` |
| `pkg/server/test_helper_linux_test.go` | `linux` -> `integration` |
| `pkg/server/testmain_linux_test.go` | `linux` -> `integration` |
| `Makefile` | `test-linux` 增加 `-tags integration` |

共 10 个文件，每个文件仅改 1 行 build tag（Makefile 改 1 行命令 + 注释）。


updateAtTime: 2026/2/8 22:05:28

planId: 309012fc-2c42-4ece-8121-e772760c17d2