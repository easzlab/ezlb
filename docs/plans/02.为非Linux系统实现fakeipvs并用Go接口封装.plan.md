### 为非Linux系统实现fakeipvs并用Go接口封装 ###
通过引入 Go 接口抽象层，将 moby/ipvs 的 Linux-only 依赖隔离到平台特定文件中，为非 Linux 系统（如 macOS）提供基于内存的 fake IPVS 实现，使项目在 macOS 上可以正常编译和测试。


## 核心思路

当前项目直接依赖 `github.com/moby/ipvs`，该包所有核心文件均为 `_linux.go`，在 macOS 上无法编译。需要：

1. 在本项目中重新定义 IPVS 数据模型（脱离对 `moby/ipvs` 类型的直接依赖）
2. 定义 Go 接口抽象 IPVS 操作
3. 通过 build tags 分别提供 Linux 真实实现和非 Linux fake 实现

---

### 步骤 1: 在 `pkg/lvs` 下新建 IPVS 数据模型

**新建文件**: `pkg/lvs/ipvs_models.go`（无 build tag，跨平台）

定义本项目自己的 IPVS 数据结构，替代直接使用 `moby/ipvs` 的类型：

- `Service` — 对应 `ipvs.Service`，包含 `Address`、`Protocol`、`Port`、`FWMark`、`SchedName`、`Flags`、`Timeout`、`Netmask`、`AddressFamily` 等字段
- `Destination` — 对应 `ipvs.Destination`，包含 `Address`、`Port`、`Weight`、`ConnectionFlags`、`AddressFamily` 等字段
- 常量定义 — `ConnectionFlagMasq`、`RoundRobin`、`WeightedRoundRobin` 等调度算法和转发模式常量（从 `constants_linux.go` 搬过来）

---

### 步骤 2: 定义 IPVS Handle 接口

**新建文件**: `pkg/lvs/ipvs_handle.go`（无 build tag，跨平台）

定义接口 `IPVSHandle`：

```go
type IPVSHandle interface {
    Close()
    NewService(svc *Service) error
    UpdateService(svc *Service) error
    DelService(svc *Service) error
    GetServices() ([]*Service, error)
    NewDestination(svc *Service, dst *Destination) error
    UpdateDestination(svc *Service, dst *Destination) error
    DelDestination(svc *Service, dst *Destination) error
    GetDestinations(svc *Service) ([]*Destination, error)
    Flush() error
}
```

同时定义工厂函数签名（具体实现由平台文件提供）：

```go
// NewIPVSHandle 由平台特定文件实现
func NewIPVSHandle(path string) (IPVSHandle, error)
```

---

### 步骤 3: Linux 真实实现

**新建文件**: `pkg/lvs/ipvs_handle_linux.go`（build tag: `//go:build linux`）

- 导入 `github.com/moby/ipvs`
- 实现 `linuxHandle` 结构体，内部包装 `*ipvs.Handle`
- 实现 `NewIPVSHandle` 函数，调用 `ipvs.New(path)` 创建真实 handle
- 在每个方法中做本项目 `Service`/`Destination` 与 `moby/ipvs` 类型之间的转换

---

### 步骤 4: 非 Linux fake 实现

**新建文件**: `pkg/lvs/ipvs_handle_fake.go`（build tag: `//go:build !linux`）

- 实现 `fakeHandle` 结构体，使用内存 map 存储 services 和 destinations
- 数据结构：`map[ServiceKey]*Service` 存储 service，`map[ServiceKey]map[DestinationKey]*Destination` 存储 destinations
- 所有 CRUD 方法操作内存 map，模拟真实 IPVS 行为（包括重复创建报错、删除不存在报错等）
- `NewIPVSHandle` 返回 `fakeHandle` 实例
- 加 `sync.Mutex` 保证并发安全

---

### 步骤 5: 修改 `pkg/lvs/manager.go`

- 将 `handle` 字段类型从 `*ipvs.Handle` 改为 `IPVSHandle`
- 将 `NewManager` 中的 `ipvs.New("")` 改为 `NewIPVSHandle("")`
- 移除 `import "github.com/moby/ipvs"`
- 所有方法中的 `*ipvs.Service` / `*ipvs.Destination` 改为本项目的 `*Service` / `*Destination`

---

### 步骤 6: 修改 `pkg/lvs/types.go`

- 移除 `import "github.com/moby/ipvs"`
- `ServiceKeyFromIPVS` 和 `DestinationKeyFromIPVS` 改为使用本项目的 `*Service` / `*Destination` 类型（函数名可改为 `ServiceKeyFromService` / `DestinationKeyFromDest`，或保持原名但改参数类型）
- `ConfigToIPVSService` 返回本项目的 `*Service`
- `ConfigToIPVSDestination` 返回本项目的 `*Destination`
- 常量引用（如 `ipvs.ConnectionFlagMasq`）改为本项目定义的常量

---

### 步骤 7: 修改 `pkg/lvs/reconciler.go`

- 移除 `import "github.com/moby/ipvs"`
- `desiredService` 中的 `*ipvs.Service` / `[]*ipvs.Destination` 改为本项目类型
- 其他引用 `ipvs.Service` / `ipvs.Destination` 的地方同步修改

---

### 步骤 8: 修改 `pkg/server/server.go`

- 无需修改 import（它只依赖 `pkg/lvs`，不直接依赖 `moby/ipvs`）
- 确认编译通过即可

---

### 步骤 9: 处理 `syscall` 跨平台兼容

`pkg/lvs/types.go` 中使用了 `syscall.IPPROTO_TCP`、`syscall.IPPROTO_UDP`、`syscall.AF_INET`、`syscall.AF_INET6`。这些常量在 macOS 的 `syscall` 包中也存在，无需特殊处理。确认编译即可。

---

### 步骤 10: 为 fake 实现编写单元测试

**新建文件**: `pkg/lvs/ipvs_handle_fake_test.go`（build tag: `//go:build !linux`）

测试用例覆盖：
- 创建/获取/更新/删除 Service
- 创建/获取/更新/删除 Destination
- 重复创建 Service 应报错
- 删除不存在的 Service 应报错
- Flush 清空所有数据
- 并发安全性测试

---

### 步骤 11: 验证编译和测试

在 macOS 上执行：

```bash
go build ./...
go test ./pkg/lvs/... -v
```

确保所有代码在 macOS 上可以正常编译和测试通过。

---

### 文件变更总览

| 操作 | 文件路径 | 说明 |
|------|---------|------|
| 新建 | `pkg/lvs/ipvs_models.go` | 跨平台 IPVS 数据模型和常量 |
| 新建 | `pkg/lvs/ipvs_handle.go` | `IPVSHandle` 接口定义 |
| 新建 | `pkg/lvs/ipvs_handle_linux.go` | Linux 真实实现（包装 moby/ipvs） |
| 新建 | `pkg/lvs/ipvs_handle_fake.go` | 非 Linux fake 实现（内存 map） |
| 新建 | `pkg/lvs/ipvs_handle_fake_test.go` | fake 实现的单元测试 |
| 修改 | `pkg/lvs/manager.go` | 使用 `IPVSHandle` 接口替代 `*ipvs.Handle` |
| 修改 | `pkg/lvs/types.go` | 使用本项目类型替代 `moby/ipvs` 类型 |
| 修改 | `pkg/lvs/reconciler.go` | 使用本项目类型替代 `moby/ipvs` 类型 |


updateAtTime: 2026/2/8 08:15:23

planId: ca7b3e71-f0ab-4b8d-9537-f49ea04a7c87