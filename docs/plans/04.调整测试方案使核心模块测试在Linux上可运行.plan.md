### 调整测试方案使核心模块测试在Linux上可运行 ###
通过 Go 接口抽象屏蔽不同系统的 IPVS 实现差异，测试代码统一，newTestManager 根据平台自动选择 fakeHandle（macOS）或真实 linuxHandle（Linux），Linux 上始终要求 root 权限运行测试。


## 问题根因

`fakeHandle` 被 `//go:build !linux` 限制，所有依赖它的测试也被标记为 `!linux`，导致 Linux 上核心模块无测试覆盖。

## 设计原则

- **测试代码完全一致**，不按平台区分测试文件
- `newTestManager` 根据平台自动创建合适的 Manager：macOS 用 `fakeHandle`，Linux 用真实 `linuxHandle`
- Linux 上始终要求 root 权限运行测试，不做 skip

---

### 步骤 1: 为 Manager 添加支持注入 handle 的构造函数

在 `pkg/lvs/manager.go` 中新增：

```go
func newManagerWithHandle(handle IPVSHandle, logger *zap.Logger) *Manager
```

原 `NewManager` 保持不变。

### 步骤 2: 创建平台感知的测试 helper（通过 build tag 分文件）

新建两个测试 helper 文件，提供统一的 `newTestManager` 函数，内部根据平台选择不同实现：

- **新建** `pkg/lvs/test_helper_linux_test.go`（`//go:build linux`）
  - `newTestManager(t)` 内部调用 `newManagerWithHandle(NewIPVSHandle(""))` — 使用真实 IPVS
  
- **新建** `pkg/lvs/test_helper_other_test.go`（`//go:build !linux`）
  - `newTestManager(t)` 内部调用 `newManagerWithHandle(NewIPVSHandle(""))` — 使用 fakeHandle（因为非 Linux 上 `NewIPVSHandle` 返回 fake）

> 由于 `NewIPVSHandle` 本身已经通过 build tag 在不同平台返回不同实现，`newTestManager` 实际上可以统一写成一个无 build tag 的文件直接调用 `NewManager`。但为了明确语义和未来扩展（如 Linux 上需要额外的 setup/teardown），建议分文件。

同理为 server 包创建：
- **新建** `pkg/server/test_helper_linux_test.go`
- **新建** `pkg/server/test_helper_other_test.go`

### 步骤 3: 移除所有测试文件的 `!linux` build tag

以下文件删除 `//go:build !linux`，测试代码本身不做任何修改：

1. `pkg/lvs/ipvs_handle_fake_test.go` — 此文件保留 `!linux` tag（它专门测试 fake 实现，Linux 上不需要）
2. `pkg/lvs/manager_test.go` — **删除** build tag，使用 `newTestManager(t)`
3. `pkg/lvs/reconciler_test.go` — **删除** build tag，使用 `newTestManager(t)` 构建环境
4. `pkg/lvs/types_test.go` — **删除** build tag（纯逻辑，无平台依赖）
5. `pkg/server/server_integration_test.go` — **删除** build tag

### 步骤 4: 调整 Server 集成测试构造方式

- 在 `pkg/server/server.go` 中新增测试可用的构造函数，接受外部传入的 `*lvs.Manager`：
  ```go
  func newServerWithManager(configPath string, lvsMgr *lvs.Manager, logger *zap.Logger) (*Server, error)
  ```
- 集成测试中的 `NewServer` 调用改为使用此函数，注入通过 `newTestManager` 创建的 Manager

### 步骤 5: Linux 测试环境的 IPVS 清理

- 在 Linux 的 `newTestManager` 中，创建 Manager 后调用 `handle.Flush()` 清理残留的 IPVS 规则
- 在测试的 `defer mgr.Close()` 前也加上 `Flush()`，确保测试间不互相干扰

### 步骤 6: 处理 cloneIP 命名冲突

- `ipvs_handle_linux.go` 中有 `cloneIP`，`ipvs_handle_fake.go` 中有 `cloneFakeIP`
- 将公共的 IP clone 函数提取到 `ipvs_models.go` 中，两个平台文件共用

### 步骤 7: 验证

- macOS: `go test ./...` 全部通过
- Linux (root): `go test ./...` 全部通过，lvs/server 模块测试走真实 IPVS 路径

---

## 变更文件清单

| 操作 | 文件 |
|------|------|
| 修改 | `pkg/lvs/manager.go` — 新增 `newManagerWithHandle` |
| 新建 | `pkg/lvs/test_helper_linux_test.go` |
| 新建 | `pkg/lvs/test_helper_other_test.go` |
| 修改 | `pkg/lvs/manager_test.go` — 删除 build tag |
| 修改 | `pkg/lvs/reconciler_test.go` — 删除 build tag |
| 修改 | `pkg/lvs/types_test.go` — 删除 build tag |
| 保留 | `pkg/lvs/ipvs_handle_fake_test.go` — 保留 `!linux` tag |
| 修改 | `pkg/server/server.go` — 新增 `newServerWithManager` |
| 新建 | `pkg/server/test_helper_linux_test.go` |
| 新建 | `pkg/server/test_helper_other_test.go` |
| 修改 | `pkg/server/server_integration_test.go` — 删除 build tag |
| 可选 | `pkg/lvs/ipvs_models.go` — 提取公共 `cloneIP` |


updateAtTime: 2026/2/8 09:23:02

planId: d736c50e-e8d7-49e5-aed7-bddd346ec543