### 增加HTTP方式健康检查 ###
在现有 TCP 健康检查基础上，增加可选的 HTTP 健康检查方式。用户可以在配置文件中通过 type 字段选择 tcp 或 http，HTTP 模式支持配置路径、期望状态码等参数。


## 现状分析

当前项目仅支持 TCP 健康检查：
- `pkg/healthcheck/checker.go` 定义了 `Checker` 接口和 `TCPChecker` 实现
- `pkg/healthcheck/manager.go` 的 `UpdateTargets` 中硬编码 `NewTCPChecker`
- `pkg/config/config.go` 的 `HealthCheckConfig` 无检查类型字段

## 实施步骤

### 步骤 1：扩展配置结构体 `HealthCheckConfig`

**文件**: `pkg/config/config.go`

在 `HealthCheckConfig` 中新增以下字段：
- `Type string` - 健康检查类型，可选值 `tcp`（默认）、`http`
- `HTTPPath string` - HTTP 健康检查请求路径，默认 `/`
- `HTTPExpectedStatus int` - 期望的 HTTP 状态码，默认 `200`

新增辅助方法：
- `GetType() string` - 返回检查类型，默认 `tcp`
- `GetHTTPPath() string` - 返回 HTTP 路径，默认 `/`
- `GetHTTPExpectedStatus() int` - 返回期望状态码，默认 `200`

在 `Validate` 函数中增加校验：
- `type` 字段仅允许 `tcp` 或 `http`（或为空，默认 `tcp`）
- 当 `type` 为 `http` 时，`http_path` 必须以 `/` 开头（如果设置了的话）
- `http_expected_status` 必须在 100-599 范围内（如果设置了的话）

### 步骤 2：实现 `HTTPChecker`

**文件**: `pkg/healthcheck/checker.go`

新增 `HTTPChecker` 结构体，实现 `Checker` 接口：
- 字段：`timeout`、`path`、`expectedStatus`
- `Check(address string)` 方法：向 `http://{address}{path}` 发送 GET 请求，检查响应状态码是否匹配期望值
- 使用 `http.Client` 并设置超时

新增构造函数 `NewHTTPChecker(timeout, path, expectedStatus)`

### 步骤 3：修改 Manager 根据配置选择 Checker 类型

**文件**: `pkg/healthcheck/manager.go`

修改 `UpdateTargets` 方法中创建 checker 的逻辑（约第 99 行）：
- 当前硬编码：`checker := NewTCPChecker(svcCfg.HealthCheck.GetTimeout())`
- 改为根据 `svcCfg.HealthCheck.GetType()` 选择创建 `TCPChecker` 或 `HTTPChecker`

### 步骤 4：补充单元测试

**文件**: `pkg/healthcheck/checker_test.go`

新增 HTTP 健康检查测试用例：
- `TestHTTPChecker_Success` - 启动本地 HTTP server，验证正常返回 200
- `TestHTTPChecker_UnexpectedStatus` - 后端返回非期望状态码，验证报错
- `TestHTTPChecker_ConnectionRefused` - 连接不可达，验证报错
- `TestHTTPChecker_CustomPath` - 验证自定义路径生效
- `TestHTTPChecker_Timeout` - 验证超时场景

**文件**: `pkg/config/config_test.go`

新增配置校验测试用例：
- `TestValidate_HealthCheckTypeHTTP` - type 为 http 时校验通过
- `TestValidate_HealthCheckTypeInvalid` - type 为非法值时校验失败
- `TestGetType_Default` - 未设置 type 时默认返回 tcp

### 步骤 5：更新示例配置和文档

**文件**: `examples/ezlb.yaml`

在某个 service 中增加 HTTP 健康检查的示例配置，展示 `type`、`http_path`、`http_expected_status` 的用法。

**文件**: `README.md`、`README_CN.md`

更新健康检查相关描述，说明支持 TCP 和 HTTP 两种模式。

## 配置示例

```yaml
health_check:
  enabled: true
  type: http              # 可选: tcp (默认), http
  interval: 5s
  timeout: 3s
  fail_count: 3
  rise_count: 2
  http_path: /healthz     # HTTP 模式专用，默认 /
  http_expected_status: 200  # HTTP 模式专用，默认 200
```


updateAtTime: 2026/2/11 07:18:24

planId: 5b2638e7-5c0b-4463-b112-60fa0266afba