### 扩展支持UDP流量负载均衡 ###
在现有 TCP 负载均衡基础上扩展支持 UDP 协议。由于 IPVS 底层和类型转换层已完全支持 UDP，核心改动集中在配置校验层，同时需要处理同 IP:Port 不同协议的服务共存场景，并补充测试和文档。


## 现状分析

项目的 IPVS 操作层（`pkg/lvs/`）已经完全支持 UDP 协议：
- `pkg/lvs/types.go` 的 `protocolFromString`/`protocolToString` 已处理 `"udp"` <-> `syscall.IPPROTO_UDP`
- `pkg/lvs/ipvs_models.go` 的 `Service.Protocol` 是 `uint16`，天然支持 TCP/UDP
- `pkg/lvs/ipvs_handle_linux.go` 和 `ipvs_handle_fake.go` 通过 protocol 字段区分服务，无需修改
- `pkg/lvs/types_test.go` 已有 UDP 协议转换测试

**唯一的阻塞点**在配置校验层 `pkg/config/config.go`，以及相关的测试和文档。

## 实施步骤

### 步骤 1：修改配置校验 — 允许 UDP 协议

**文件**: `pkg/config/config.go`

1. 将 `validProtocols` 从 `{"tcp": true}` 扩展为 `{"tcp": true, "udp": true}`
2. 修改 `Validate` 函数中协议校验的错误信息，将 `(supported: tcp)` 改为 `(supported: tcp, udp)`
3. 修改 `listenSet` 的去重 key，从单纯的 `svc.Listen`（即 `IP:Port`）改为 `svc.Listen + "/" + protocol`，因为 IPVS 允许同一 IP:Port 同时存在 TCP 和 UDP 服务

### 步骤 2：补充配置校验单元测试

**文件**: `pkg/config/config_test.go`

新增测试用例：
- `TestValidate_ProtocolUDP` — protocol 为 `udp` 时校验通过
- `TestValidate_ProtocolEmptyDefaultsTCP` — 已有，确认 UDP 不影响默认行为
- `TestValidate_SameListenDifferentProtocol` — 同一 IP:Port 分别配置 TCP 和 UDP 服务，校验通过（不报重复）
- `TestValidate_SameListenSameProtocolDuplicate` — 同一 IP:Port 同一协议，校验报重复

### 步骤 3：补充 Reconciler 单元测试

**文件**: `pkg/lvs/reconciler_test.go`

新增测试用例：
- `TestReconcile_UDPService` — 验证 UDP 协议的 service 能正确创建和 reconcile
- `TestReconcile_TCPAndUDPSameAddress` — 验证同一 IP:Port 的 TCP 和 UDP 服务能共存且独立管理

### 步骤 4：更新示例配置

**文件**: `examples/ezlb.yaml`

新增一个 UDP 服务的示例配置，如 DNS 负载均衡场景：
```yaml
- name: dns-service
  listen: 10.0.0.3:53
  protocol: udp
  scheduler: rr
  health_check:
    enabled: false
  backends:
    - address: 192.168.4.10:53
      weight: 1
    - address: 192.168.4.11:53
      weight: 1
```

### 步骤 5：更新文档

**文件**: `README.md`、`README_CN.md`

1. 特性描述从 "Layer-4 TCP load balancer" 改为 "Layer-4 TCP/UDP load balancer"
2. 配置示例中增加 UDP 服务示例
3. 说明 `protocol` 字段支持 `tcp`（默认）和 `udp`

## 不需要修改的模块

- **`pkg/lvs/types.go`** — 已支持 UDP 协议转换
- **`pkg/lvs/manager.go`** — 协议无关，无需修改
- **`pkg/lvs/reconciler.go`** — 通过 `ServiceKey`（含 Protocol）区分服务，已支持
- **`pkg/lvs/ipvs_handle*.go`** — 底层 IPVS 操作已支持 UDP
- **`pkg/healthcheck/`** — 健康检查类型（TCP/HTTP）与服务协议独立，UDP 服务可选择禁用健康检查或使用 TCP/HTTP 探测
- **`pkg/server/`** — 无协议相关逻辑


updateAtTime: 2026/2/12 08:09:18

planId: 845ead06-d442-4206-aae1-5044843630b5