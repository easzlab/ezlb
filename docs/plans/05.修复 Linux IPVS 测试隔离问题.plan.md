### 修复 Linux IPVS 测试隔离问题 ###
通过 go test -p 1 串行运行包、使用 TestMain 做全局 Flush、以及修复死锁问题，确保 Linux 上所有 IPVS 测试稳定通过。


## 问题根因

1. **跨包并行**：`go test ./...` 默认并行运行 `pkg/lvs` 和 `pkg/server`，两个包各自有独立的 `sync.Mutex`，无法跨包互斥，导致两个包的测试同时操作全局 IPVS 内核状态
2. **同一测试内死锁**：`TestIntegration_FlowA_InitialSync` 调用了两次 `newTestServer`，而 `newTestServer` 每次都 `ipvsMu.Lock()`，第二次调用会死锁
3. **Cleanup 时序**：`defer mgr.Close()` 在 `t.Cleanup` 之前执行，关闭 netlink socket 后 Cleanup 中的 Flush 依赖独立 handle，但时序上可能与下一个测试的 Lock+Flush 交错

## 修复方案

### 步骤 1：在 `pkg/lvs` 和 `pkg/server` 中添加 Linux 专用的 `TestMain`

在每个包中创建 `testmain_linux_test.go`，使用 `TestMain` 在所有测试开始前和结束后做一次全局 Flush，并通过 `-test.parallel=1` 或 `t.Setenv` 确保包内串行。

- **`pkg/lvs/testmain_linux_test.go`**（新建）
  - `TestMain` 函数：测试开始前 Flush，测试结束后 Flush
- **`pkg/server/testmain_linux_test.go`**（新建）
  - 同上

### 步骤 2：简化 `newTestManager`（Linux 版）

修改 `pkg/lvs/test_helper_linux_test.go`：
- 移除 `sync.Mutex`（改用 `TestMain` + 串行执行保证隔离）
- `newTestManager` 只做：创建 Manager -> Flush -> 注册 `t.Cleanup` 做 Flush（使用独立 handle）
- 不再需要加锁/解锁逻辑

### 步骤 3：简化 `newTestServer` / `newTestLVSManager`（Linux 版）

修改 `pkg/server/test_helper_linux_test.go`：
- 移除 `sync.Mutex`
- `newTestServer` 只做：创建 Manager -> Flush -> 注册 Cleanup -> 创建 Server
- `newTestLVSManager` 同理

### 步骤 4：修复 `TestIntegration_FlowA_InitialSync` 的双重调用问题

修改 `pkg/server/server_integration_test.go`：
- `TestIntegration_FlowA_InitialSync` 中第二次调用 `newTestServer` 改为直接创建 `newServerWithManager`，复用已有的 LVS Manager 或创建新 Manager 但不重复 Flush/Lock
- 或者重构测试逻辑，避免在同一个测试中调用两次 `newTestServer`

### 步骤 5：运行时使用 `-p 1` 确保跨包串行

由于 IPVS 是全局内核资源，不同包的测试必须串行运行。有两种方式：
- **方式 A（推荐）**：在项目根目录添加 `Makefile` 或文档说明，Linux 上运行测试时使用 `go test -p 1 ./...`
- **方式 B**：在 `pkg/server/testmain_linux_test.go` 的 `TestMain` 中，先对 `pkg/lvs` 运行子进程测试，确保顺序（过于复杂，不推荐）

实际上最简单可靠的方式是：**Linux 上测试命令改为 `go test -count=1 -p 1 ./...`**

### 步骤 6：验证

- macOS：`go test ./...` 全部通过
- Linux：`go test -count=1 -p 1 ./...` 全部通过
- Linux 交叉编译：`GOOS=linux GOARCH=amd64 go build ./...` 通过


updateAtTime: 2026/2/8 10:29:59

planId: 39e6884c-b00f-483c-876c-88ea228f5a47